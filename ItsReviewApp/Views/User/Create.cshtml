
@{
    ViewBag.Title = "User";
}
<style type="text/css">
    .select2-results__option {
        padding-right: 20px;
        vertical-align: middle;
    }

        .select2-results__option:before {
            content: "";
            display: inline-block;
            position: relative;
            height: 20px;
            width: 20px;
            border: 2px solid #e9e9e9;
            border-radius: 4px;
            background-color: #fff;
            margin-right: 20px;
            vertical-align: middle;
        }

        .select2-results__option[aria-selected=true]:before {
            font-family: fontAwesome;
            content: "\f00c";
            color: #fff;
            background-color: #f77750;
            border: 0;
            display: inline-block;
            padding-left: 3px;
        }
</style>
<div class="container-fluid">
    <div class="header">
        <h5 style="color:#fff;margin-right: 40px;">ItsReview App</h5>
    </div>
    <div class="container" style="padding-top:30px;">
        <div class="form-group" id="user">
            <label for="user">Select User</label>
            @*@Html.DropDownList("Name", (IEnumerable<SelectListItem>)ViewBag.Name, "Select User", new { @class = "form-control", @onfocusout = "ExcelUploadEnable();" })*@
            @Html.DropDownList("Name", (IEnumerable<SelectListItem>)ViewBag.Name, "Select User", new { @class = "form-control" })

        </div>
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" class="form-control" placeholder="Enter Name" id="name">
        </div>
        <div class="form-group">
            <label for="category">Select Category</label>
            <select data-placeholder="Select Category" class='form-control dropdownCategory' name='dropdowCategory' multiple="multiple" id="dropdownCategory"></select>
        </div>
        <div class="form-group">
            <button type="button" class="btn btn-dark" id="newrows"><b>Add More</b></button>

            <div style="padding-top:10px;" class="table-responsive-sm" id="tableUser">
                <table class="table table-bordered" id="tblUsers">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            @*<th scope="col">Last Name</th>*@
                            <th scope="col">EmailId</th>
                            <th scope="col">Category</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody class="UserTableClass">
                        <tr>
                            <td>
                                <input type="text" placeholder="Enter Name" class="name form-control" value="" id="fname" />
                            </td>
                            @*<td>
                                <input type="text" placeholder="Enter Last Name" class="name form-control" value="" id="lastname" />
                            </td>*@
                            <td>
                                <input type="text" placeholder="Enter EmailId" class="name form-control" value="" id="emailid" />
                            </td>
                            <td>
                                <select data-placeholder="Select Category" class='form-control dropdownCategory' name='dropdowCategory' multiple="multiple" id="Category"></select>
                            </td>
                            <td>
                                <input type='button' id='btnDelete' class='btn btn-danger btn-sm deletebutton' Value='Delete' style='width:60px;'>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="form-group">
            <button type="button" id="btnSubmit" class="btn btn-primary btn-md btn-sm" disabled>Save</button>
            <input type="button" id="exceluploadbutton" value="Excel Upload" class="btn btn-primary btn-md btn-sm" disabled />
        </div>
        <div class="form-group excelupload">
            <input type="file" id="files" name="files" />
            <input type="button" id="excelupload" value="Upload" class="btn btn-primary btn-md btn-sm" />
        </div>
        @*<input type="file" id="files" name="files" disabled />
        <button type="button" id="btnSubmit" class="btn btn-primary btn-md btn-sm">Excel Upload</button>*@
        @*<input type="button" id="emailupload" value="Excel Upload" class="btn btn-primary" disabled />*@

    </div>
</div>

<div class="container" style="margin-top: 30px;">
    <div class="form-group">
        <table id="datatableid" class="table table-bordered table-responsive" style="width: 100%">
            <thead>
                <tr>
                    <th>Register Name</th>
                    <th>First Name</th>
                    @*<th>Last Name</th>*@
                    <th>Email Id</th>
                    <th>Category</th>
                </tr>
            </thead>
        </table>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
       /* $('#platform').multiselect();*/
        BindUsers();
        BindPlatform(0);
        BindCategory(0);
        MultiSelectChckBox();
        $(".excelupload").hide();
    });
    var count = 1;
    $("#newrows").click(function () {
        tblBind();
    });

    function tblBind() {
        var addcontrols = "<tr id=\"RowId_" + count + "\">" + count + ">"
        addcontrols += "<td><input type='text' name='firstname' placeholder='Enter Name' class='name form-control'></td>"
       /* addcontrols += "<td><input type='text' name='lastname' placeholder='Enter Last Name' class='name form-control'></td>"*/
        addcontrols += "<td><input type='text' name='emailid' placeholder='Enter Email Id' class='emailid form-control'></td>"
        addcontrols += "<td><select data-placeholder='Select Category' class='form-control dropdownCategory' name='dropdowCategory' multiple='multiple' id='dropdownCategory'></select></td>"
        addcontrols += "<td><input type='button' id='btnDelete' class='btn btn-danger btn-sm deletebutton' Value='Delete' style='width:60px;'></td>"
        addcontrols += "</tr>";
        /* $("table tbody").append(addcontrols);*/
        $("table .UserTableClass").append(addcontrols);
        BindPlatform("RowId_" + count);
        BindCategory("RowId_" + count)
        addScroll();
        MultiSelectChckBox();
        count++;
    }

    function BindCategory(id, selectedId) {
        $.ajax({
            url: "@Url.Action("category", "User")",
            type: "GET",
            dataType: "json",
            success: function (data) {

                $.each(data, function (index, item) {
                    var opt = new Option(item.Text, item.Value);
                    if (id == 0) {
                        $('.dropdownCategory').append(opt);
                    }
                    else {
                        $("#tblUsers").find("tr#" + id).find(".dropdownCategory").append(opt);
                    }

                });
                $("#tblUsers").find("tr#" + id).find(".dropdownCategory").val(selectedId);

               /* $('.dropdownCategory').chosen();*/
              /*  $("#tblSales").find("tr#" + id).find(".dropdownCategory").select2();*/
            }
        })
    }

    function BindPlatform(id, selectedId) {
        $.ajax({
            url: "@Url.Action("GetPaltform", "User")",
            type: "GET",
            dataType: "json",
            success: function (data) {
                $.each(data, function (index, item) {
                    var opt = new Option(item.Text, item.Value);
                    if (id == 0) {
                        $('.dropdownPlatform').append(opt);
                    }
                    else {
                        $("#tblUsers").find("tr#" + id).find(".dropdownPlatform").append(opt);
                    }

                });
                $("#tblUsers").find("tr#" + id).find(".dropdownPlatform").val(selectedId);
               /* $('.dropdownPlatform').chosen();*/
              /*  $("#tblSales").find("tr#" + id).find(".dropdownCategory").select2();*/
            }
        })
    }

    $("#tblUsers").on('click', '.deletebutton', function () {
        $(this).closest('tr').remove();
    });

    function addScroll() {
        if ($('#tblUsers tr').length >= 10) {
            $('#tableUser').addClass('add-scroll');
        }

    }
    function BindUsers() {
        $('#datatableid').DataTable({
            destroy: true,
            "processing": true,
            "serverSide": true,
            "filter": true,
            "pageLength": 50,
            "orderMulti": false,
            "ajax": {
                "url": "GetList/User",
                "type": "POST",
                "datatype": "json"
            },
            "columns": [
                {
                    "data": "Name",
                    "autoWidth": true,
                    "searchable": true
                },
                {
                    "data": "FirstName",
                    "autoWidth": true,
                    "searchable": true
                },
                {
                    "data": "EmailId",
                    "autoWidth": true,
                    "searchable": true
                },
                {
                    "data": "CategoryName",
                    "autoWidth": true,
                    "searchable": true
                }
            ],
        });
    }

    function MultiSelectChckBox() {
        $(".dropdownCategory").select2({
            closeOnSelect: false,
            allowClear: true,
            tags: true
        });
    }

    $('#excelupload').click(function () {
        var RegisterId = $("#user option:selected").val();
        var fileUpload = $("#files").get(0);
        var files = fileUpload.files;
        var fileData = new FormData();
        fileData.append('RegisterId', RegisterId);
        for (var i = 0; i < files.length; i++) {
            fileData.append(files[i].name, files[i]);
        }
       

        $.ajax({
            url: "@Url.Action("Upload", "User")",
           type: "POST", 
           processData: false,
           contentType: false,
             data: fileData,
            /*data: { 'RegisterId': RegisterId},*/
            success: function (result) {
                if (result.length != 0) {
                    alert("Cannot Store Email : \n" + result.toString().replaceAll(",", "\n"));
                    /*alert(result);*/
                }
                else {
                    $("#files").val('');
                    alert('Upload Successfully');
                }
            },
            error: function (result) {
                alert('failure');
            }
        });
    })

    $('#btnSubmit').click(function () {
        
        var RegisterId = $("#user option:selected").val();
        var Name = $("#name").val();
        var UserCategory = $("#dropdownCategory").val();
        var Users = new Array();
        $("#tblUsers tbody tr").each(function () {
            var row = $(this);
            var User = {};
            User.FirstName = row.find("td:eq(0) input[type='text']").val();
          /*  User.LastName = row.find("td:eq(1) input[type='text']").val();*/
            User.EmailId = row.find("td:eq(1) input[type='text']").val();
            User.UserCategoryViewModel = row.find("td:eq(2) select").val();
            if (User.UserCategoryViewModel.length == 0) {
                User.UserCategoryViewModel = UserCategory;
            }
            if (User.UserCategoryViewModel.length != 0 || UserCategory.length != 0) {
                Users.push(User);
            }
        });

        var writeobject = new Object();
        writeobject.RegisterId = RegisterId,
            writeobject.Name = Name,
            writeobject.Users = Users;

        const duplicateIds = Users
            .map(v => v.EmailId)
            .filter((v, i, vIds) => vIds.indexOf(v) !== i)
        const duplicates = Users
            .filter(obj => duplicateIds.includes(obj.EmailId));
        console.log(duplicates);
        var duplicatelist = new Array();
        for (var i = 0; i < duplicates.length; i++) {
            var duplicate = duplicates[i].EmailId;
            duplicatelist.push(duplicate + "\n");
        }
        if (duplicatelist.length > 0) {
            alert(duplicatelist);
            return;
        }
        $.ajax({
            url: 'Create/User',
            contentType: 'application/json',
            data: JSON.stringify(writeobject),
            type: "POST",
            success: function (EmailList) {
                if (EmailList.length != 0) {
                    alert("Cannot Store Email : \n" + EmailList.toString().replaceAll(",", "\n"));
                }
                else {
                    BindUsers();
                    alert('Success');
                }
            },
            error: function () {
                alert('failure');
            }
        });
    });


    $('#user').on('change', function () {
        ExcelUploadEnable();
    });


    function ExcelUploadEnable() {
        var RegisterId = $("#user option:selected").val();
        if (RegisterId == "" || RegisterId == undefined) {
            document.getElementById('exceluploadbutton').disabled = true;
            document.getElementById('btnSubmit').disabled = true;
        }
        else {
            document.getElementById('exceluploadbutton').disabled = false;
            document.getElementById('btnSubmit').disabled = false;
        }
    }

    $('#exceluploadbutton').click(function () {
        $(".excelupload").show();
    })
</script>


