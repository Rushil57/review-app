
@{
    ViewBag.Title = "Review";
}

<div class="container-fluid">
    <div class="header">
        <h5 style="color:#fff;margin-right: 40px;">ItsReview App</h5>
    </div>

    <div class="container" style="padding-top:30px;">
        <form onsubmit="return false">
            @*<div class="form-group">
                <label for="platform">Select Platform</label>
                <select class="form-control dropdownPaltform" name="dropdownPaltform"></select>
        </div>*@
            <div class="form-group">
                <div>
                    <label for="" id="suggestemailName"></label>
                </div>
                @*<label for="emailid">Email Id :</label>*@
                <div>
                    <label for="suggestedemail" style="color:red;" id="suggestemail"></label>
                </div>
                <div>
                    <label id="companyId"></label>
                </div>
                <div>
                    <label id="cityId"></label>
                </div>
                <div>
                    <input type="text" id="companyUrl" />
                    <a class="btn btn-primary" onclick="CopyURLAndPasteGo()" href="#" id="btnGo" style="margin-left:7px;">GO</a>
                </div>
                <input type="hidden" id="hdnreview" value="0" />
                <input type="hidden" id="hdnAddress" value="0" />
                <input type="hidden" id="hdnListingUrl" value="0" />
                <input type="hidden" id="hdnCompanyId" value="0" />
                <input type="hidden" id="hdnWriterId" value="0" />
                <input type="hidden" id="hdnUserId" value="0" />
                <input type="hidden" id="hdnTrackOrder" value="0" />
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary" id="startProcessId" onclick="StartReviewProcess()">Start</button>
                <button type="submit" class="btn btn-primary" id="addressId" onclick="CopyAddress()" disabled>Address</button>
                <button type="submit" class="btn btn-primary" id="reviewbutton" onclick="disablereviewbutton()" disabled>Review</button>
                <button type="submit" class="btn btn-primary" id="listingurlbutton" onclick="disableurllistingbutton()" disabled>Listing Url</button>
            </div>
            <div class="form-group" id="buttons">
                <button type="submit" class="btn btn-primary" id="showing" disabled onclick="storedata(this.id)">Next</button>
                @*<button type="submit" class="btn btn-primary" id="notshowing" disabled onclick="storedata(this.id)">Not Showing</button>*@
                <button type="submit" class="btn btn-primary" id="skip" disabled onclick="storedata(this.id)">Skip</button>
                <button type="submit" class="btn btn-primary" id="Logout" onclick="LogOut()">Log Out</button>
            </div>
            <div>
                Today Count: <label id="lblTodayCount"></label>
            </div>
            <div>
                Yesterday Count: <label id="lblYesterdayCount"></label>
            </div>

        </form>
    </div>
</div>

<script type="text/javascript">
    var companyid = 0;
    var userid = 0;
    var writerid = 0;

    $(document).ready(function () {
        BindPaltform(0);
        GetTrackUserData();
    })

    function incTimer() {
        setTimeout(function () {
            document.getElementById('reviewbutton').disabled = null;
            document.getElementById('addressId').disabled = null;
            document.getElementById('listingurlbutton').disabled = null;
        }, 10000);
    }
     function BindPaltform(id) {
        $.ajax({
            url: "@Url.Action("GetPaltform", "Register")",
            type: "GET",
            dataType: "json",
            success: function (data) {
                $.each(data, function (index, item) {
                    var opt = new Option(item.Text, item.Value);
                    if (id == 0) {
                        $('.dropdownPaltform').append(opt);
                    }
                    else {
                        $(".dropdownPaltform").val(id);

                    }
                });
            }
        })
    }

    function disablereviewbutton() {

                var review = $("#hdnreview").val();
                var $temp = $("<input>");
                $("body").append($temp);
                $temp.val(review).select();
                document.execCommand("copy");
        $temp.remove();
        TrackUserData("review");
    }

    function CopyAddress() {
                var address = $("#hdnAddress").val();
                var $temp = $("<input>");
                $("body").append($temp);
                $temp.val(address).select();
                document.execCommand("copy");
        $temp.remove();
        TrackUserData("Address");
    }

    function disableurllistingbutton() {
        TrackUserData("ListingURL");
        var listingurl = $("#hdnListingUrl").val();
        window.open(listingurl, '_blank');
        setTimeout(function () {
        document.getElementById('showing').disabled = null;
            document.getElementById('skip').disabled = null;
        }, 5000);
    }


    function BindEmailId() {
        $("#startProcessId").css("display", "none");
        $("#hdnreview").val('');
        $("#hdnAddress").val('');
        $("#hdnListingUrl").val('');
        $("#hdnCompanyId").val('');
        $("#hdnWriterId").val('');
        $("#hdnUserId").val('');
        $("#hdnTrackOrder").val('');
        $("#suggestemailName").text('');
        $.ajax({
            url: "@Url.Action("GetList", "Register")",
            type: "GET",
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                if (data.company == "WorkCompleted") {
                    $("label[for='suggestedemail']").text("work completed");
                    ResetData('WorkCompleted');
                }
                else if (data.user == "usernotlogin") {
                        var url = '@Url.Action("Login", "Login")';
                        window.location.href = url;
                }
                else if (data.user == "nocontent") {
                    $("label[for='suggestedemail']").text("No content");
                    ResetData('nocontent');
                }
                else if (data.reviews == "reviewnotfound") {
                    $("label[for='suggestedemail']").text("Review not found");
                    ResetData('reviewnotfound');
                }
                else if (data.user == "emailnotfound") {
                    $("label[for='suggestedemail']").text("Email not found");
                    ResetData('emailnotfound');
                }
                else if (data.user == "emaillimitexceed") {
                    $("label[for='suggestedemail']").text("Email limit exceed");
                    ResetData('emaillimitexceed');
                }
                else {
                    $("label[for='suggestedemail']").text(data.user.EmailId);
                    $("#hdnreview").val(data.reviews.ReviewName);
                    $("#hdnAddress").val(data.company.Address);
                    $("#hdnListingUrl").val(data.company.ListingUrl);
                    $("#hdnCompanyId").val(data.company.Id);
                    $("#companyId").text(data.company.CompanyName)
                    $("#hdnWriterId").val(data.reviews.Id);
                    $("#hdnUserId").val(data.user.Id);
                    $("#suggestemailName").text(data.user.FirstName);
                    $("#cityId").text(data.company.CityName);
                    $("#companyUrl").val(data.company.UserListingUrl);
                    $("#hdnTrackOrder").val(data.company.TrackOrder);
                    $("#lblTodayCount").text(data.userTrack.TodayCount);
                    $("#lblYesterdayCount").text(data.userTrack.YesterDayCount);
                    incTimer();
                }


            }
        })
    }

    function storedata(id) {
        document.getElementById('showing').disabled = true;
        document.getElementById('skip').disabled = true;
        document.getElementById('reviewbutton').disabled = true;
        document.getElementById('addressId').disabled = true;
        document.getElementById('listingurlbutton').disabled = true;
        var buttonclick = id;
        var label = $('#suggestemail').text();
        var writeobject = new Object();
        writeobject.CompanyId = $("#hdnCompanyId").val();
            writeobject.WriterId = $("#hdnWriterId").val();
        writeobject.UserId = $("#hdnUserId").val();
        writeobject.Status = buttonclick;
        writeobject.EmailId = label;
        writeobject.UserListingUrl = $("#companyUrl").val();
        writeobject.TrackOrder = $("#hdnTrackOrder").val();

         $.ajax({
            url: "@Url.Action("SaveTrackingData", "User")",
            contentType: 'application/json',
            data: JSON.stringify(writeobject),
          /*  dataType: "json",*/
            type: "POST",
             success: function (result) {
                 BindEmailId();
            },
             error: function (result) {
                 document.getElementById('showing').disabled = null;
                 document.getElementById('skip').disabled = null;
                 document.getElementById('reviewbutton').disabled = null;
                 document.getElementById('addressId').disabled = null;
                 document.getElementById('listingurlbutton').disabled = null;
                 alert('failure');
            }
        });

    }

    function StartReviewProcess() {
        BindEmailId();
    }
    function CopyURLAndPasteGo() {
        var url = $("#companyUrl").val();
        if (url != '') {
            $("#btnGo").attr("target", "_blank");
            $("#btnGo").attr("href", url);
        }
        else {
            $("#btnGo").attr("target", "");
            $("#btnGo").attr("href", '#');
        }
    }

     function TrackUserData(name) {
         var writeobject = new Object();
         writeobject.CompanyId = $("#hdnCompanyId").val();
         writeobject.WriterId = $("#hdnWriterId").val();
         writeobject.UserId = $("#hdnUserId").val();
         writeobject.EmailId = $('#suggestemail').text();
         writeobject.UserListingUrl = $("#companyUrl").val();
         writeobject.TrackOrder = $("#hdnTrackOrder").val();
         writeobject.ReviewName = $("#hdnreview").val();
         writeobject.Address = $("#hdnAddress").val();
         writeobject.Type = name;
         writeobject.City = $("#cityId").text();
         writeobject.CompanyName = $("#companyId").text();
         writeobject.Name = $("#suggestemailName").text();
         writeobject.Listingurl = $("#hdnListingUrl").val();
         $.ajax({
            url: "@Url.Action("SaveTrackUserData", "User")",
            contentType: 'application/json',
             data: JSON.stringify(writeobject),
            type: "POST",
             success: function (result) {
            },
             error: function (result) {

            }
        });

    }

    function GetTrackUserData() {
         $.ajax({
            url: "@Url.Action("GetTrackUserData", "User")",
            type: "GET",
            dataType: "json",
            success: function (data) {
                if (data.length > 0) {
                   $("#startProcessId").css("display","none")
                    $("#hdnreview").val(data[0].ReviewName);
                    $("#hdnAddress").val(data[0].Address);
                    $("#hdnListingUrl").val(data[0].Listingurl);
                    $("#hdnCompanyId").val(data[0].CompanyId);
                    $("#hdnWriterId").val(data[0].WriterId);
                    $("#hdnUserId").val(data[0].UserId);
                    $("#hdnTrackOrder").val(data[0].TrackOrder);
                    $("#cityId").text(data[0].City);
                    $("#companyId").text(data[0].CompanyName);
                    $('#suggestemail').text(data[0].EmailId)
                    $("#suggestemailName").text(data[0].Name);
                    $("#companyUrl").val(data[0].UserListingUrl)
                    /*$("#listingurlbutton").text(data[0].Listingurl)*/
                    if (data[0].Type == "ListingURL") {
                        document.getElementById('reviewbutton').disabled = null;
                        document.getElementById('addressId').disabled = null;
                        document.getElementById('listingurlbutton').disabled = null;
                        document.getElementById('showing').disabled = null;
                        document.getElementById('skip').disabled = null;
                    }
                    else {
                        document.getElementById('reviewbutton').disabled = null;
                        document.getElementById('addressId').disabled = null;
                        document.getElementById('listingurlbutton').disabled = null;
                    }
                }
                else {
                    //var pageLodVal = $("#hdnDefaultPage").val();
                    //if (pageLodVal == 0) {
                        $("#startProcessId").css("dispaly", "block");
                    //}
                }
            }
        })
    }

    function LogOut() {
        ResetData('logout');
        $.ajax({
            url: "@Url.Action("Logout", "User")",
            type: "GET",
            dataType: "json",
            success: function (data) {

            }
        })
         var url = '@Url.Action("Login", "Login")';
                  window.location.href = url;
    }
    function ResetData(name) {
        $("#hdnreview").val('');
        $("#hdnAddress").val('');
        $("#hdnListingUrl").val('');
        $("#hdnCompanyId").val('');
        $("#hdnWriterId").val('');
        $("#hdnUserId").val('');
        $("#hdnTrackOrder").val('');
        if (name == "logout") {
            $('#suggestemail').text('')
        }
        $("#suggestemailName").text('');
        $("#companyUrl").val('');
        $("#companyId").text('');
        $("#cityId").text('');
    }
</script>